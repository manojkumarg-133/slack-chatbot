import { NextRequest, NextResponse } from 'next/server';import { NextRequest, NextResponse } from 'next/server';

import { import { 

  getOrCreateUser,   getOrCreateUser, 

  getOrCreateConversation,  getOrCreateConversation,

} from '@/lib/database';} from '@/lib/database';

import { import { 

  clearConversation,  clearConversation,

  createNewConversationForUser,  createNewConversationForUser,

  deleteConversationData,  deleteConversationData,

  getConversationStats,  getConversationStats,

} from '@/lib/slashCommands';  muteUser,

  unmuteUser,

// Helper function to send delayed responses using response_url  isUserMuted

async function sendDelayedResponse(responseUrl: string, message: string, isError = false) {} from '@/lib/slashCommands';

  try {

    await fetch(responseUrl, {// Helper function to send delayed responses using response_url

      method: 'POST',async function sendDelayedResponse(responseUrl: string, message: string, isError = false) {

      headers: {  try {

        'Content-Type': 'application/json',    await fetch(responseUrl, {

      },      method: 'POST',

      body: JSON.stringify({      headers: {

        response_type: 'ephemeral',        'Content-Type': 'application/json',

        text: isError ? `‚ùå ${message}` : message      },

      }),      body: JSON.stringify({

    });        response_type: 'ephemeral',

  } catch (error) {        text: isError ? `‚ùå ${message}` : message

    console.error('Error sending delayed response:', error);      }),

  }    });

}  } catch (error) {

    console.error('Error sending delayed response:', error);

export async function POST(request: NextRequest) {  }

  try {}

    console.log('üîç Incoming slash command request');

    export async function POST(request: NextRequest) {

    const body = await request.text();  try {

        console.log('üîç Incoming slash command request');

    if (!body) {    

      console.log('‚ö†Ô∏è Empty request body');    const body = await request.text();

      return NextResponse.json({ ok: true }, { status: 200 });    

    }    if (!body) {

          console.log('‚ö†Ô∏è Empty request body');

    // Parse the form data      return NextResponse.json({ ok: true }, { status: 200 });

    const params = new URLSearchParams(body);    }

    const command = params.get('command');    

    const text = params.get('text') || '';    // Parse the form data

    const userId = params.get('user_id');    const params = new URLSearchParams(body);

    const channelId = params.get('channel_id');    const command = params.get('command');

    const responseUrl = params.get('response_url');    const text = params.get('text') || '';

        const userId = params.get('user_id');

    console.log('üì® Received slash command:', command);    const channelId = params.get('channel_id');

    console.log('üë§ User ID:', userId);    const responseUrl = params.get('response_url');

    

    // Verify the request is from Slack    console.log('üì® Received slash command:', command);

    if (!userId || !channelId || !command || !responseUrl) {    console.log('üë§ User ID:', userId);

      console.log('‚ùå Invalid request - missing required fields');

      return NextResponse.json(    // Verify the request is from Slack

        {     if (!userId || !channelId || !command || !responseUrl) {

          response_type: "ephemeral",      console.log('‚ùå Invalid request - missing required fields');

          text: "‚ùå Invalid request. Please try again."       return NextResponse.json(

        },         { 

        { status: 200 }          response_type: "ephemeral",

      );          text: "‚ùå Invalid request. Please try again." 

    }        }, 

        { status: 200 }

    // Handle different commands and respond immediately to avoid timeout      );

    switch (command) {    }

      case '/clear':

        setTimeout(async () => {    // Handle different commands and respond immediately to avoid timeout

          try {    switch (command) {

            const user = await getOrCreateUser(userId);      case '/clear':

            if (!user) {        // Acknowledge immediately (within 3 seconds)

              await sendDelayedResponse(responseUrl, 'Error finding your user account.', true);        setTimeout(async () => {

              return;          try {

            }            const user = await getOrCreateUser(userId);

                        if (!user) {

            const conversation = await getOrCreateConversation(user.id, channelId);              await sendDelayedResponse(responseUrl, 'Error finding your user account.', true);

            if (!conversation) {              return;

              await sendDelayedResponse(responseUrl, 'No conversation found.', true);            }

              return;            

            }            const conversation = await getOrCreateConversation(user.id, channelId);

                        if (!conversation) {

            const stats = await getConversationStats(conversation.id);              await sendDelayedResponse(responseUrl, 'No conversation found.', true);

            if (!stats || stats.messageCount === 0) {              return;

              await sendDelayedResponse(responseUrl, '‚ÑπÔ∏è No messages to clear. Your chat is already empty!');            }

              return;            

            }            const stats = await getConversationStats(conversation.id);

            if (!stats || stats.messageCount === 0) {

            const result = await clearConversation(conversation.id);              await sendDelayedResponse(responseUrl, '‚ÑπÔ∏è No messages to clear. Your chat is already empty!');

            if (result) {              return;

              await sendDelayedResponse(responseUrl, `‚úÖ **Screen Cleared!**            }



üìä Cleared ${stats.messageCount} messages from screen view.            const result = await clearConversation(conversation.id);

            if (result) {

üíæ Database kept intact - conversation continues with same ID.`);              await sendDelayedResponse(responseUrl, `‚úÖ **Chat Cleared!**

              console.log(`‚úÖ User ${userId} cleared screen for conversation ${conversation.id}`);

            } else {üìä Cleared ${stats.messageCount} messages from this conversation.

              await sendDelayedResponse(responseUrl, 'Failed to clear chat. Please try again.', true);

            }Your conversation history has been reset. Future messages will start a fresh conversation with context.`);

          } catch (error) {              console.log(`‚úÖ User ${userId} cleared conversation ${conversation.id}`);

            console.error('‚ùå Error in /clear command:', error);            } else {

            await sendDelayedResponse(responseUrl, 'An error occurred while clearing the chat.', true);              await sendDelayedResponse(responseUrl, 'Failed to clear chat. Please try again.', true);

          }            }

        }, 50);          } catch (error) {

            console.error('‚ùå Error in /clear command:', error);

        return NextResponse.json({            await sendDelayedResponse(responseUrl, 'An error occurred while clearing the chat.', true);

          response_type: "ephemeral",          }

          text: "üîÑ Clearing messages from screen..."        }, 50); // Reduced delay to respond faster

        }, { status: 200 });

        return NextResponse.json({

      case '/delete':          response_type: "ephemeral",

        setTimeout(async () => {          text: "üîÑ Clearing your conversation history..."

          try {        }, { status: 200 });

            const user = await getOrCreateUser(userId);

            if (!user) {      case '/new-chat':

              await sendDelayedResponse(responseUrl, 'Error finding your user account.', true);        setTimeout(async () => {

              return;          try {

            }            const user = await getOrCreateUser(userId);

            if (!user) {

            const conversation = await getOrCreateConversation(user.id, channelId);              await sendDelayedResponse(responseUrl, 'Error finding your user account.', true);

            if (!conversation) {              return;

              await sendDelayedResponse(responseUrl, 'No conversation found to delete.', true);            }

              return;

            }            const newConversationId = await createNewConversationForUser(user.id, channelId);

            if (newConversationId) {

            const stats = await getConversationStats(conversation.id);              await sendDelayedResponse(responseUrl, `‚úÖ **New Chat Started!**

            const success = await deleteConversationData(conversation.id);

            üÜï Conversation ID: \`${newConversationId}\`

            if (success) {

              await sendDelayedResponse(responseUrl, `‚úÖ **Conversation Deleted**Your conversation history has been reset. This is now a fresh conversation with the AI assistant.`);

              console.log(`‚úÖ User ${userId} started new conversation ${newConversationId}`);

üóëÔ∏è Deleted from screen and database:            } else {

‚Ä¢ ${stats?.messageCount || 0} messages              await sendDelayedResponse(responseUrl, 'Failed to start new chat. Please try again.', true);

‚Ä¢ ${stats?.responseCount || 0} responses              }

‚Ä¢ ${stats?.reactionCount || 0} reactions          } catch (error) {

            console.error('‚ùå Error in /new-chat command:', error);

Your conversation has been completely removed.`);            await sendDelayedResponse(responseUrl, 'An error occurred while starting new chat.', true);

              console.log(`‚úÖ User ${userId} deleted conversation data`);          }

            } else {        }, 50);

              await sendDelayedResponse(responseUrl, 'Failed to delete conversation. Please try again.', true);

            }        return NextResponse.json({

          } catch (error) {          response_type: "ephemeral",

            console.error('‚ùå Error in /delete command:', error);          text: "üîÑ Starting a new chat conversation..."

            await sendDelayedResponse(responseUrl, 'An error occurred while deleting the conversation.', true);        }, { status: 200 });

          }

        }, 50);      case '/delete':

        setTimeout(async () => {

        return NextResponse.json({          try {

          response_type: "ephemeral",            const user = await getOrCreateUser(userId);

          text: "üóëÔ∏è Deleting conversation from screen and database..."            if (!user) {

        }, { status: 200 });              await sendDelayedResponse(responseUrl, 'Error finding your user account.', true);

              return;

      case '/new-chat':            }

        setTimeout(async () => {

          try {            const conversation = await getOrCreateConversation(user.id, channelId);

            const user = await getOrCreateUser(userId);            if (!conversation) {

            if (!user) {              await sendDelayedResponse(responseUrl, 'No conversation found to delete.', true);

              await sendDelayedResponse(responseUrl, 'Error finding your user account.', true);              return;

              return;            }

            }

            const stats = await getConversationStats(conversation.id);

            const newConversationId = await createNewConversationForUser(user.id, channelId);            const success = await deleteConversationData(conversation.id);

            if (newConversationId) {            

              await sendDelayedResponse(responseUrl, `‚úÖ **New Chat Started!**            if (success) {

              await sendDelayedResponse(responseUrl, `‚úÖ **Conversation Deleted**

üÜï Conversation ID: \`${newConversationId}\`

üóëÔ∏è Deleted from screen and database:

Screen cleared and fresh conversation started. Your previous conversations remain in the database.`);‚Ä¢ ${stats?.messageCount || 0} messages

              console.log(`‚úÖ User ${userId} started new conversation ${newConversationId}`);‚Ä¢ ${stats?.responseCount || 0} responses  

            } else {‚Ä¢ ${stats?.reactionCount || 0} reactions

              await sendDelayedResponse(responseUrl, 'Failed to start new chat. Please try again.', true);

            }Your conversation has been completely removed.`);

          } catch (error) {              console.log(`‚úÖ User ${userId} deleted conversation data`);

            console.error('‚ùå Error in /new-chat command:', error);            } else {

            await sendDelayedResponse(responseUrl, 'An error occurred while starting new chat.', true);              await sendDelayedResponse(responseUrl, 'Failed to delete conversation. Please try again.', true);

          }            }

        }, 50);          } catch (error) {

            console.error('‚ùå Error in /delete command:', error);

        return NextResponse.json({            await sendDelayedResponse(responseUrl, 'An error occurred while deleting the conversation.', true);

          response_type: "ephemeral",          }

          text: "üîÑ Starting a new chat conversation..."        }, 50);

        }, { status: 200 });

        return NextResponse.json({

      case '/help':          response_type: "ephemeral",

        return NextResponse.json({          text: "ÔøΩÔ∏è Deleting conversation from screen and database..."

          response_type: "ephemeral",        }, { status: 200 });

          text: `ü§ñ **Zen-AI Bot Commands**

      case '/help':

**Available Commands:**        return NextResponse.json({

‚Ä¢ \`/clear\` - Clear messages from screen (keeps database)          response_type: "ephemeral",

‚Ä¢ \`/delete\` - Delete conversation from screen AND database            text: `ü§ñ **Zen-AI Bot Commands**

‚Ä¢ \`/new-chat\` - Start a fresh conversation with new ID

‚Ä¢ \`/help\` - Show this help message**Available Commands:**

‚Ä¢ \`/clear\` - Clear messages from screen (keeps database)

**Features:**‚Ä¢ \`/delete\` - Delete conversation from screen AND database  

‚úÖ Multi-language support (responds in your language)‚Ä¢ \`/new-chat\` - Start a fresh conversation with new ID

‚úÖ Conversation history and context‚Ä¢ \`/help\` - Show this help message

‚úÖ Emoji reaction sentiment analysis

‚úÖ Works in channels and DMs**Features:**

‚úÖ Multi-language support (responds in your language)

Need help? Just @mention me with your question! üí¨`‚úÖ Conversation history and context

        }, { status: 200 });‚úÖ Emoji reaction sentiment analysis

‚úÖ Works in channels and DMs

      default:

        return NextResponse.json({Need help? Just @mention me with your question! üí¨`

          response_type: "ephemeral",        }, { status: 200 });

          text: `‚ùì **Unknown Command: \`${command}\`**

      default:

Available commands:        return NextResponse.json({

‚Ä¢ \`/clear\` - Clear messages from screen only          response_type: "ephemeral",

‚Ä¢ \`/delete\` - Delete conversation completely          text: `‚ùì **Unknown Command: \`${command}\`**

‚Ä¢ \`/new-chat\` - Start a new conversation

‚Ä¢ \`/help\` - Show help message`Available commands:

        }, { status: 200 });‚Ä¢ \`/clear\` - Clear messages from screen only

    }‚Ä¢ \`/delete\` - Delete conversation completely

‚Ä¢ \`/new-chat\` - Start a new conversation

  } catch (error) {‚Ä¢ \`/help\` - Show help message`

    console.error('‚ùå Error handling slash command:', error);        }, { status: 200 });

    return NextResponse.json({    }

      response_type: "ephemeral", 

      text: "‚ùå An unexpected error occurred. Please try again."  } catch (error) {

    }, { status: 200 });    console.error('‚ùå Error handling slash command:', error);

  }    return NextResponse.json({

}      response_type: "ephemeral", 

      text: "‚ùå An unexpected error occurred. Please try again."

// Handle GET requests (Slack sometimes sends these for verification)    }, { status: 200 });

export async function GET() {  }

  return NextResponse.json({ message: 'Slash commands endpoint is working' }, { status: 200 });}

}
// Handle GET requests (Slack sometimes sends these for verification)
export async function GET() {
  return NextResponse.json({ message: 'Slash commands endpoint is working' }, { status: 200 });
}

      case '/unmute':
        setTimeout(async () => {
          try {
            if (!isUserMuted(userId)) {
              await sendDelayedResponse(responseUrl, '‚ÑπÔ∏è You are not currently muted.');
              return;
            }

            const result = unmuteUser(userId);
            if (result) {
              await sendDelayedResponse(responseUrl, `üîä **You are now unmuted**

The AI assistant will respond to your messages again.

Welcome back! Feel free to start chatting.`);
              console.log(`‚úÖ User ${userId} unmuted themselves`);
            } else {
              await sendDelayedResponse(responseUrl, 'Failed to unmute. Please try again.', true);
            }
          } catch (error) {
            console.error('‚ùå Error in /unmute command:', error);
            await sendDelayedResponse(responseUrl, 'An error occurred while unmuting.', true);
          }
        }, 50);

        return NextResponse.json({
          response_type: "ephemeral",
          text: "üîÑ Unmuting your interactions..."
        }, { status: 200 });

      case '/help':
        return NextResponse.json({
          response_type: "ephemeral",
          text: `ü§ñ **Zen-AI Bot Commands**

**Conversation Management:**
‚Ä¢ \`/clear\` - Clear conversation history
‚Ä¢ \`/new-chat\` - Start a fresh conversation
‚Ä¢ \`/stats\` - View conversation statistics

**Account Management:**
‚Ä¢ \`/delete-data confirm\` - Permanently delete all your data
‚Ä¢ \`/mute\` - Mute AI responses (bot won't respond to you)
‚Ä¢ \`/unmute\` - Re-enable AI responses

**Other:**
‚Ä¢ \`/help\` - Show this help message

**Features:**
‚úÖ Multi-language support (responds in your language)
‚úÖ Conversation history and context
‚úÖ Emoji reaction sentiment analysis
‚úÖ Works in channels and DMs

Need help? Just @mention me with your question! üí¨`
        }, { status: 200 });

      case '/stats':
        setTimeout(async () => {
          try {
            const user = await getOrCreateUser(userId);
            if (!user) {
              await sendDelayedResponse(responseUrl, 'Error finding your user account.', true);
              return;
            }
            
            const conversation = await getOrCreateConversation(user.id, channelId);
            if (!conversation) {
              await sendDelayedResponse(responseUrl, 'No conversation found.', true);
              return;
            }
            
            const stats = await getConversationStats(conversation.id);
            if (!stats) {
              await sendDelayedResponse(responseUrl, 'Unable to retrieve statistics.', true);
              return;
            }

            await sendDelayedResponse(responseUrl, `ÔøΩ **Conversation Statistics**

ÔøΩüí¨ **Messages:** ${stats.messageCount} total
üóìÔ∏è **Created:** ${new Date(conversation.created_at).toLocaleDateString()}
üìù **Title:** ${conversation.conversation_title || 'Untitled'}
üÜî **Conversation ID:** \`${conversation.id}\`

${stats.messageCount > 0 ? '‚úÖ Active conversation with history' : 'üìù New conversation - no messages yet'}`);
          } catch (error) {
            console.error('‚ùå Error in /stats command:', error);
            await sendDelayedResponse(responseUrl, 'An error occurred while retrieving statistics.', true);
          }
        }, 50);

        return NextResponse.json({
          response_type: "ephemeral",
          text: "üìä Retrieving your conversation statistics..."
        }, { status: 200 });

      default:
        // Unknown command
        console.log('‚ùå Unknown command:', command);
        return NextResponse.json({
          response_type: "ephemeral",
          text: `‚ùå Unknown command: ${command}

Available commands:
‚Ä¢ \`/clear\` - Clear conversation history
‚Ä¢ \`/new-chat\` - Start a new conversation  
‚Ä¢ \`/delete-data confirm\` - Delete all your data
‚Ä¢ \`/mute\` - Mute AI responses
‚Ä¢ \`/unmute\` - Unmute AI responses`
        }, { status: 200 });
    }

  } catch (error) {
    console.error('‚ùå Error handling slash command:', error);
    return NextResponse.json({
      response_type: "ephemeral", 
      text: "‚ùå An unexpected error occurred. Please try again."
    }, { status: 200 });
  }
}

// Handle GET requests (Slack sometimes sends these for verification)
export async function GET() {
  return NextResponse.json({ message: 'Slash commands endpoint is working' }, { status: 200 });
}